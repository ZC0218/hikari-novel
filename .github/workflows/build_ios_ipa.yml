name: Build Hikari Novel iOS IPA (Real Device Release)
on:
  workflow_dispatch:  # 手动触发编译

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 解压源码压缩包（适配你的仓库）
      - name: Unzip Source Code
        run: |
          # 找到唯一的 zip 文件
          ZIP_FILE=$(find . -name "*.zip" -type f | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ No zip file found!"
            exit 1
          fi
          echo "✅ Found zip: $ZIP_FILE"
          
          # 解压到临时目录
          unzip -q "$ZIP_FILE" -d temp_unzip
          
          # 找到解压后包含 pubspec.yaml 的目录（Flutter 项目根）
          PROJECT_ROOT=$(find temp_unzip -name "pubspec.yaml" -type f | head -1 | xargs dirname)
          if [ -z "$PROJECT_ROOT" ]; then
            echo "❌ No pubspec.yaml found in zip!"
            exit 1
          fi
          echo "✅ Found Flutter project root at: $PROJECT_ROOT"
          
          # 把项目所有内容复制到工作目录根
          cp -R "$PROJECT_ROOT"/* ./
          
          # 删除临时目录
          rm -rf temp_unzip
          
          # 打印最终目录结构，确认项目文件存在
          echo "=== Final directory structure ==="
          ls -la

      # 2. 安装 Flutter（匹配项目要求）
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      # 3. 安装 iOS 依赖
      - name: Install Dependencies
        run: |
          flutter pub get
          cd ios
          pod install --repo-update
          cd ..

      # 4. 编译真实设备 Release 版（修复：移除了 --arch 参数）
      - name: Build iOS Release (Real Device)
        run: |
          flutter build ios --release --no-simulator --no-codesign

      # 5. 打包成 IPA（使用你提供的精简方式）
      - name: Export IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/iphoneos/Runner.app Payload/
          zip -r hikari-novel-real-device.ipa Payload
          rm -rf Payload

      # 6. 上传 IPA 产物
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: hikari-novel-ios-real-device
          path: hikari-novel-real-device.ipa
