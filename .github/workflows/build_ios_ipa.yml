name: Build
on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      # 新增：解压上传的源码压缩包（适配你的场景）
      - name: Unzip Source Code
        run: |
          # 找到仓库中唯一的 zip 文件
          ZIP_FILE=$(find . -name "*.zip" -type f | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "❌ No zip file found!"
            exit 1
          fi
          echo "✅ Found zip: $ZIP_FILE"
          
          # 解压到临时目录
          unzip -q "$ZIP_FILE" -d temp_unzip
          
          # 找到解压后包含 .xcodeproj 或 .xcworkspace 的目录（即项目根）
          PROJECT_ROOT=$(find temp_unzip -name "*.xcodeproj" -o -name "*.xcworkspace" | head -1 | xargs dirname)
          if [ -z "$PROJECT_ROOT" ]; then
            echo "❌ No Xcode project found in zip!"
            exit 1
          fi
          echo "✅ Found project root at: $PROJECT_ROOT"
          
          # 把项目所有内容复制到工作目录根
          cp -R "$PROJECT_ROOT"/* .
          
          # 删除临时目录
          rm -rf temp_unzip
          
          # 打印最终目录结构，确认项目文件存在
          echo "=== Final directory structure ==="
          ls -la

      - name: Build
        run: |
          # 注意：把 "你的项目名" 替换成你项目中 scheme 的真实名称
          xcodebuild -scheme "你的项目名" -configuration Release -archivePath build/app.xcarchive archive CODE_SIGNING_ALLOWED=NO

      - name: Export IPA
        run: |
          mkdir -p Payload
          cp -r build/app.xcarchive/Products/Applications/*.app Payload/
          zip -r app.ipa Payload

      - uses: actions/upload-artifact@v4
        with:
          name: IPA
          path: app.ipa
