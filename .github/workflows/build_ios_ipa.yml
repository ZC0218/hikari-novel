name: Build iOS IPA from Zip (Fixed)
on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build-ipa:
    runs-on: macos-latest
    steps:
      # 1. 检出仓库（含上传的压缩包）
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 自动解压压缩包（优化：避免路径混乱）
      - name: Unzip Source Code (Fixed)
        run: |
          # 找到唯一的zip包并校验
          ZIP_FILE=$(ls *.zip | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "Error: No zip file found in repository!"
            exit 1
          fi
          echo "Processing zip file: $ZIP_FILE"
          # 解压到临时目录
          unzip -o "$ZIP_FILE" -d ./temp_source
          # 进入解压后的项目根目录（处理压缩包内一级文件夹）
          cd ./temp_source || exit 1
          PROJECT_DIR=$(find . -name "pubspec.yaml" -type f | dirname | head -1)
          cd "$PROJECT_DIR" || exit 1
          # 复制所有源码到仓库根目录
          cp -r ./* ../../
          cd ../../
          # 删除临时目录
          rm -rf ./temp_source

      # 3. 安装 Flutter 3.19.0（匹配项目Dart版本）
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      # 4. 安装 iOS 核心依赖（CocoaPods）
      - name: Install iOS Dependencies
        run: |
          # 升级Ruby环境（解决CocoaPods安装兼容问题）
          gem update --system --quiet
          gem install cocoapods --quiet
          # 安装Flutter依赖
          flutter pub get
          # 进入ios目录安装Pod依赖（核心步骤）
          cd ios || exit 1
          pod install --repo-update
          cd ..

      # 5. 编译 iOS 模拟器版（删除了冲突的create步骤）
      - name: Build iOS Simulator App
        run: |
          flutter build ios --debug --simulator --verbose
          # 验证编译产物是否存在
          if [ ! -d "build/ios/iphonesimulator/Runner.app" ]; then
            echo "Error: iOS build product not found!"
            exit 1
          fi

      # 6. 打包成 IPA（仅模拟器版）
      - name: Package to IPA
        run: |
          IPA_DIR=./ipa-output
          mkdir -p "$IPA_DIR"
          # 打包Runner.app为IPA
          ditto -c -k --sequesterRsrc --keepParent \
            build/ios/iphonesimulator/Runner.app \
            "$IPA_DIR/hikari-novel-ios-simulator.ipa"
          echo "IPA generated at: $IPA_DIR/hikari-novel-ios-simulator.ipa"

      # 7. 上传 IPA 产物
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hikari-novel-ios-ipa
          path: ipa-output/*.ipa
          if-no-files-found: error  # 无产物时直接报错，便于排查
